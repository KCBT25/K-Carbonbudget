<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>탄소감축 시나리오 시뮬레이터</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; display: flex; gap: 40px; align-items: flex-start; }
    #main { flex: 1; }
    svg { border: 1px solid #ccc; margin-top: 20px; }
    .line { fill: none; stroke-width: 3px; }
    .fixed-line { stroke: steelblue; }
    .user-line { stroke: crimson; }
    .compare-line { stroke: gray; stroke-dasharray: 4; opacity: 0.6; }
    .axis-label { font-size: 12px; fill: #333; }
    label { display: block; margin: 10px 0 5px; }
    input[type=range] { width: 300px; }
    .marker { fill: white; stroke: black; stroke-width: 2px; }
    table { border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
    th { background-color: #f0f0f0; }
    .highlight { font-weight: bold; background-color: #fff6d6; }
    .compare-button { margin-right: 8px; margin-top: 5px; }
    .circle-stats { display: flex; gap: 20px; margin-top: 10px; align-items: center; }
    .circle { border-radius: 50%; display: inline-block; text-align: center; line-height: 1; font-size: 14px; color: white; }
  </style>
</head>
<body>
<div id="main">
  <h2>탄소감축 시나리오 시뮬레이터</h2>
  <div>
    <label>탄소예산 (2020~탄소중립연도, GtCO₂): <input type="number" id="budgetInput" value="87.4"></label>
    <div class="circle-stats">
      <div id="cumCircle" class="circle" style="background-color: steelblue; width: 50px; height: 50px;">0</div>
      <div id="overCircle" class="circle" style="background-color: crimson; width: 50px; height: 50px;">0</div>
      <span>누적 배출량 / 초과 배출량</span>
    </div>
    <label>감축곡선 형태:
      <select id="curveType">
        <option value="linear">선형 (Linear)</option>
        <option value="exponential">지수형 (Exponential)</option>
        <option value="logistic">로지스틱형 (Logistic)</option>
      </select>
    </label>
    <label>탄소중립 목표연도: <input type="range" id="targetYear" min="2040" max="2050" value="2050"> <span id="targetYearLabel">2050</span></label>
    <label>2035년 감축률 (%): <input type="range" id="r35" min="0" max="100" value="50"> <span id="v35">50%</span></label>
    <label>2040년 감축률 (%): <input type="range" id="r40" min="0" max="100" value="70"> <span id="v40">70%</span></label>
    <label>2045년 감축률 (%): <input type="range" id="r45" min="0" max="100" value="85"> <span id="v45">85%</span></label>
    <button class="compare-button" onclick="saveScenario()">+ 시나리오 저장</button>
    <button class="compare-button" onclick="clearComparisons()">비교 초기화</button>
  </div>
  <svg width="1000" height="500"></svg>
</div>
<div>
  <h3>연도별 배출량 (GtCO₂)</h3>
  <table id="dataTable">
    <thead><tr><th>연도</th><th>배출량</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const svg = d3.select("svg"),
    margin = {top: 20, right: 30, bottom: 30, left: 60},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const fixedData = {
    2018: 6.591, 2019: 6.361, 2020: 5.874, 2021: 6.131,
    2022: 5.974, 2023: 5.995, 2024: 5.912, 2025: 5.841,
    2026: 5.702, 2027: 5.533, 2028: 5.302, 2029: 5.008, 2030: 4.129
  };

  const base = 6.591;
  const years = d3.range(2018, 2051);

  const x = d3.scaleLinear().domain([2018, 2050]).range([0, width]);
  const y = d3.scaleLinear().domain([0, base]).range([height, 0]);

  g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
  g.append("g").call(d3.axisLeft(y));

  // 점선 가이드라인 (2020)
  g.append("line")
    .attr("x1", x(2020)).attr("x2", x(2020))
    .attr("y1", y(0)).attr("y2", y(base))
    .attr("stroke", "gray")
    .attr("stroke-dasharray", "4,4")
    .attr("opacity", 0.5);

  const line = d3.line().x(d => x(d.year)).y(d => y(d.value));
  const fixedPoints = years.filter(y => fixedData[y] !== undefined).map(year => ({ year, value: fixedData[year] }));
  g.append("path").datum(fixedPoints).attr("class", "line fixed-line").attr("d", line);

  const userPath = g.append("path").attr("class", "line user-line");
  const compareGroup = g.append("g");

  const markerYears = [2030, 2035, 2040, 2045];
  const markers = g.selectAll(".marker")
    .data(markerYears.map(y => ({ year: y, value: 0 })))
    .enter().append("circle")
    .attr("class", "marker")
    .attr("r", 5);

  const sliders = {
    r35: document.getElementById("r35"),
    r40: document.getElementById("r40"),
    r45: document.getElementById("r45")
  };
  const spans = {
    r35: document.getElementById("v35"),
    r40: document.getElementById("v40"),
    r45: document.getElementById("v45")
  };
  const targetSlider = document.getElementById("targetYear");
  const targetLabel = document.getElementById("targetYearLabel");
  const curveType = document.getElementById("curveType");
  const tableBody = document.querySelector("#dataTable tbody");

  const cumCircle = document.getElementById("cumCircle");
  const overCircle = document.getElementById("overCircle");

  let savedScenarios = [];

  targetSlider.addEventListener("input", () => {
    targetLabel.textContent = targetSlider.value;
    updateScenario();
  });
  Object.values(sliders).forEach(slider => slider.addEventListener("input", updateScenario));
  document.getElementById("budgetInput").addEventListener("input", updateScenario);
  curveType.addEventListener("change", updateScenario);

  function updateScenario() {
    spans.r35.textContent = sliders.r35.value + "%";
    spans.r40.textContent = sliders.r40.value + "%";
    spans.r45.textContent = sliders.r45.value + "%";

    const netZeroYear = parseInt(targetSlider.value);
    const curve = curveType.value;

    const targets = {
      2030: fixedData[2030],
      2035: base * (1 - sliders.r35.value / 100),
      2040: base * (1 - sliders.r40.value / 100),
      2045: base * (1 - sliders.r45.value / 100),
      [netZeroYear]: 0
    };

    const scenario = [];
    for (let y = 2030; y <= netZeroYear; y++) {
      let value;
      if (curve === "linear") {
        if (y <= 2035) value = targets[2030] + (targets[2035] - targets[2030]) * ((y - 2030) / 5);
        else if (y <= 2040) value = targets[2035] + (targets[2040] - targets[2035]) * ((y - 2035) / 5);
        else if (y <= 2045) value = targets[2040] + (targets[2045] - targets[2040]) * ((y - 2040) / 5);
        else value = targets[2045] * (1 - ((y - 2045) / (netZeroYear - 2045)));
      } else if (curve === "exponential") {
        const start = fixedData[2030];
        const a = start;
        const b = Math.log(a / 0.001) / (netZeroYear - 2030);
        value = a * Math.exp(-b * (y - 2030));
      } else if (curve === "logistic") {
        const L = fixedData[2030];
        const k = 0.4;
        const x0 = (netZeroYear - 2030) / 2;
        value = L / (1 + Math.exp(k * (y - 2030 - x0)));
      }
      scenario.push({ year: y, value });
    }

    userPath.datum(scenario).attr("d", line);

    const budget = parseFloat(document.getElementById("budgetInput").value);
    const allYears = years.map(y => {
      if (fixedData[y] !== undefined) return { year: y, value: fixedData[y] };
      const found = scenario.find(d => d.year === y);
      return found ? { year: y, value: found.value } : null;
    }).filter(Boolean).filter(d => d.year >= 2018 && d.year <= netZeroYear);

    const total = allYears.filter(d => d.year >= 2020).reduce((sum, d) => sum + d.value, 0);
    const over = total - budget;

    cumCircle.textContent = total.toFixed(1);
    overCircle.textContent = over.toFixed(1);
    cumCircle.style.width = cumCircle.style.height = `${Math.sqrt(total) * 15}px`;
    overCircle.style.width = overCircle.style.height = `${Math.sqrt(Math.abs(over)) * 15}px`;

    markers.data(markerYears.map(y => {
      const d = allYears.find(e => e.year === y) || { year: y, value: 0 };
      return d;
    })).attr("cx", d => x(d.year)).attr("cy", d => y(d.value));

    tableBody.innerHTML = allYears.map(d => `<tr class="${[2030, 2035, 2040, 2045, 2050].includes(d.year) ? 'highlight' : ''}"><td>${d.year}</td><td>${d.value.toFixed(3)}</td></tr>`).join("");
  }

  function saveScenario() {
    const path = userPath.datum();
    compareGroup.append("path")
      .datum(path.map(d => ({...d})))
      .attr("class", "line compare-line")
      .attr("d", line);
    savedScenarios.push(path);
  }

  function clearComparisons() {
    savedScenarios = [];
    compareGroup.selectAll("path").remove();
  }

  updateScenario();
</script>
</body>
</html>
