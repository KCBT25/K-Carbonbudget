<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>탄소감축 시나리오 시뮬레이터</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; display: flex; gap: 40px; align-items: flex-start; }
    #main { flex: 1; }
    svg { border: 1px solid #ccc; margin-top: 20px; }
    .line { fill: none; stroke-width: 3px; }
    .fixed-line { stroke: steelblue; }
    .user-line { stroke: crimson; }
    .compare-line { stroke-width: 3px; opacity: 0.6; }
    .axis-label { font-size: 12px; fill: #333; }
    label { display: block; margin: 10px 0 5px; }
    input[type=range] { width: 300px; }
    .marker { fill: white; stroke: black; stroke-width: 2px; }
    table { border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
    th { background-color: #f0f0f0; }
    .highlight { font-weight: bold; background-color: #fff6d6; }
    .compare-button { margin-right: 8px; margin-top: 5px; }
    .circle-stats { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
    .circle { border-radius: 50%; display: inline-block; text-align: center; line-height: 1; font-size: 14px; color: white; min-width: 30px; min-height: 30px; }
    #statContainer { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
    #scenarioStats { margin-top: 10px; font-size: 14px; }
    .tooltip { position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; font-size: 12px; pointer-events: none; display: none; }
  </style>
</head>
<body>
<div id="main">
  <h2>탄소감축 시나리오 시뮬레이터</h2>
  <div style="display: flex; gap: 20px; align-items: flex-start;">
    <div>
      <label>탄소예산 (2020~탄소중립연도, 억tCO₂): <input type="number" id="budgetInput" value="87.4"></label>
      <label>탄소중립 목표연도: <input type="range" id="targetYear" min="2040" max="2050" value="2050"> <span id="targetYearLabel">2050</span></label>
      <label>2035년 감축률 (%): <input type="range" id="r35" min="0" max="100" value="50"> <span id="v35">50%</span></label>
      <label>2040년 감축률 (%): <input type="range" id="r40" min="0" max="100" value="70"> <span id="v40">70%</span></label>
      <label>2045년 감축률 (%): <input type="range" id="r45" min="0" max="100" value="85"> <span id="v45">85%</span></label>
      <button class="compare-button" onclick="saveScenario()">+ 시나리오 저장</button>
      <button class="compare-button" onclick="resetSettings()">비교 초기화</button>
    </div>
    <div id="statContainer">
      <div class="circle-stats">
        <div id="cumCircle" class="circle" style="background-color: steelblue;">0</div>
        <div id="overCircle" class="circle" style="background-color: crimson;">0</div>
        <span>누적 배출량 / 초과 배출량</span>
      </div>
    </div>
  </div>
  <svg width="1000" height="500"></svg>
  <div id="scenarioStats"></div>
</div>
<div>
  <h3>연도별 배출량 (억tCO₂)
    <button onclick="togglePre2030()">2030년 이전 값 보기</button>
  </h3>
  <table id="dataTable">
    <thead><tr><th>연도</th><th>배출량</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
  const svg = d3.select("svg"),
    margin = {top: 20, right: 30, bottom: 30, left: 60},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const tooltip = d3.select("#tooltip");

  const fixedData = {
    2018: 6.591, 2019: 6.361, 2020: 5.874, 2021: 6.131,
    2022: 5.974, 2023: 5.995, 2024: 5.912, 2025: 5.841,
    2026: 5.702, 2027: 5.533, 2028: 5.302, 2029: 5.008, 2030: 4.129
  };

  const base = 6.591;
  const years = d3.range(2018, 2051);

  const x = d3.scaleLinear().domain([2018, 2050]).range([0, width]);
  const y = d3.scaleLinear().domain([0, base]).range([height, 0]);

  g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
  g.append("g").call(d3.axisLeft(y));

  g.append("line")
    .attr("x1", x(2020)).attr("x2", x(2020))
    .attr("y1", y(0)).attr("y2", y(base))
    .attr("stroke", "gray")
    .attr("stroke-dasharray", "4,4")
    .attr("opacity", 0.5);

  const line = d3.line().x(d => x(d.year)).y(d => y(d.value));
  const fixedPoints = years.filter(y => fixedData[y] !== undefined).map(year => ({ year, value: fixedData[year] }));
  g.append("path").datum(fixedPoints).attr("class", "line fixed-line").attr("d", line);

  const userPath = g.append("path").attr("class", "line user-line");
  const compareGroup = g.append("g");

  const markerYears = [2030, 2035, 2040, 2045];
  const markers = g.selectAll(".marker")
    .data(markerYears.map(y => ({ year: y, value: 0 })))
    .enter().append("circle")
    .attr("class", "marker")
    .attr("r", 5);

  const sliders = {
    r35: document.getElementById("r35"),
    r40: document.getElementById("r40"),
    r45: document.getElementById("r45")
  };
  const spans = {
    r35: document.getElementById("v35"),
    r40: document.getElementById("v40"),
    r45: document.getElementById("v45")
  };
  const targetSlider = document.getElementById("targetYear");
  const targetLabel = document.getElementById("targetYearLabel");
  const tableBody = document.querySelector("#dataTable tbody");
  const cumCircle = document.getElementById("cumCircle");
  const overCircle = document.getElementById("overCircle");

  let savedScenarios = [];
  let showPre2030 = false;

  function togglePre2030() {
    showPre2030 = !showPre2030;
    updateScenario();
  }

  targetSlider.addEventListener("input", () => {
    targetLabel.textContent = targetSlider.value;
    updateScenario();
  });
  Object.values(sliders).forEach(slider => slider.addEventListener("input", updateScenario));
  document.getElementById("budgetInput").addEventListener("input", updateScenario);

  function updateScenario() {
    spans.r35.textContent = sliders.r35.value + "%";
    spans.r40.textContent = sliders.r40.value + "%";
    spans.r45.textContent = sliders.r45.value + "%";

    const netZeroYear = parseInt(targetSlider.value);
    const targets = {
      2030: fixedData[2030],
      2035: base * (1 - sliders.r35.value / 100),
      2040: base * (1 - sliders.r40.value / 100),
      2045: base * (1 - sliders.r45.value / 100),
      [netZeroYear]: 0
    };

    const scenario = [];
    for (let y = 2030; y <= netZeroYear; y++) {
      let value;
      if (y <= 2035) value = targets[2030] + (targets[2035] - targets[2030]) * ((y - 2030) / 5);
      else if (y <= 2040) value = targets[2035] + (targets[2040] - targets[2035]) * ((y - 2035) / 5);
      else if (y <= 2045) value = targets[2040] + (targets[2045] - targets[2040]) * ((y - 2040) / 5);
      else value = targets[2045] * (1 - ((y - 2045) / (netZeroYear - 2045)));
      scenario.push({ year: y, value });
    }

    userPath.datum(scenario).attr("d", line);

    const budget = parseFloat(document.getElementById("budgetInput").value);
    const allYears = years.map(y => {
      if (fixedData[y] !== undefined) return { year: y, value: fixedData[y] };
      const found = scenario.find(d => d.year === y);
      return found ? { year: y, value: found.value } : null;
    }).filter(Boolean).filter(d => d.year >= 2018 && d.year <= netZeroYear);

    const total = allYears.filter(d => d.year >= 2020).reduce((sum, d) => sum + d.value, 0);
    const over = total - budget;

    cumCircle.textContent = total.toFixed(1);
    overCircle.textContent = over.toFixed(1);
    cumCircle.style.width = cumCircle.style.height = `${Math.max(30, Math.sqrt(total) * 15)}px`;
    overCircle.style.width = overCircle.style.height = `${Math.max(30, Math.sqrt(Math.abs(over)) * 15)}px`;

    markers.data(markerYears.map(y => {
      const d = allYears.find(e => e.year === y) || { year: y, value: 0 };
      return d;
    })).attr("cx", d => x(d.year)).attr("cy", d => y(d.value));

    tableBody.innerHTML = allYears
      .filter(d => showPre2030 || d.year >= 2030)
      .map(d => `<tr class="${[2030, 2035, 2040, 2045, 2050].includes(d.year) ? 'highlight' : ''}"><td>${d.year}</td><td>${d.value.toFixed(3)}</td></tr>`)
      .join("");

    const circles = g.selectAll(".hover-circle").data(scenario);
    circles.enter().append("circle")
      .attr("class", "hover-circle")
      .attr("r", 5)
      .attr("fill", "transparent")
      .attr("stroke", "transparent")
      .merge(circles)
      .attr("cx", d => x(d.year))
      .attr("cy", d => y(d.value))
      .on("mouseover", (event, d) => {
        tooltip.style("display", "block").html(`${d.year}년: ${d.value.toFixed(3)} 억t`);
      })
      .on("mousemove", (event) => {
        tooltip.style("left", (event.pageX + 10) + "px")
               .style("top", (event.pageY - 20) + "px");
      })
      .on("mouseout", () => {
        tooltip.style("display", "none");
      });

    userPath.datum().budgetTotal = total;
    userPath.datum().overAmount = over;
  }

  function saveScenario() {
    const path = userPath.datum().map(d => ({...d}));
    const color = d3.schemeCategory10[savedScenarios.length % 10];
    compareGroup.append("path")
      .datum(path)
      .attr("class", "line compare-line")
      .attr("stroke", color)
      .attr("d", line);

    const total = userPath.datum().budgetTotal || 0;
    const over = userPath.datum().overAmount || 0;
    const index = savedScenarios.length + 1;

    d3.select("#scenarioStats").append("div")
      .style("color", color)
      .html(`시나리오 ${index}: 누적 ${total.toFixed(1)} 억t, 초과 ${over.toFixed(1)} 억t`);

    savedScenarios.push(path);
  }

  function resetSettings() {
    sliders.r35.value = 50;
    sliders.r40.value = 70;
    sliders.r45.value = 85;
    targetSlider.value = 2050;
    document.getElementById("budgetInput").value = 87.4;
    document.getElementById("scenarioStats").innerHTML = "";
    compareGroup.selectAll("path").remove();
    savedScenarios = [];
    showPre2030 = false;
    updateScenario();
  }

  updateScenario();
</script>
</body>
</html>
